version: "3.8"

services:
  drone:
    build: .
    entrypoint: /bin/sh -c "exec /app/drone \
      -id=$(hostname) \
      -sample-sec=${SAMPLE_SEC:-10} \
      -fanout=${FANOUT:-3} \
      -ttl=${TTL:-4} \
      -bind=0.0.0.0"

    expose:
      - "7000/udp"
      - "8080/tcp"
    networks: [drone-net]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # opcional: agregador para /stats (mostrado anteriormente)
  aggregator:
    image: curlimages/curl:8.8.0
    networks: [drone-net]
    entrypoint: |
      sh -c '
        while true; do
          for h in $$(getent hosts | awk "/drone_/ {print \$2}"); do
            echo "== $$h ==";
            curl -s http://$$h:8080/stats || echo "(offline)";
          done;
          sleep ${INTERVAL_SEC:-15};
        done'

networks:
  drone-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16